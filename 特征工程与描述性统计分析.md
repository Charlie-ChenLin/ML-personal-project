# 特征工程与描述性统计分析（时间序列：PP 价格月度预测）

本文件对应 `2025年个人PJ.docx` 的“数据预处理（特征工程 + 描述统计）”要求，覆盖：

- **原始数据（PP数据/*.xlsx）**：起止时间、频率、缺失、分布、趋势等
- **整理后的月度数据**：
  - 月度特征汇总表（未 shift，便于理解数据覆盖与对齐）
  - 建模数据集（已做 `shift(1)`，严格用月 t-1 的信息预测月 t）

所有分析均提供 **可复现脚本**（生成表格与图保存到 `outputs/eda/`）。

---

## 1) 已实现的特征工程（在不引入时间泄露前提下）

实现位置：`pp_forecast/feature_engineering.py`

在建模数据集（`pp_*.csv`）的特征列已统一做 `shift(1)` 的前提下，新增特征只基于这些“已滞后”的序列做派生，不会使用未来信息。

### A. 日历/时间特征

- `cal_time_index`：时间序号（捕捉长期趋势）
- `cal_month_sin` / `cal_month_cos`：月份循环编码（捕捉季节性）

### B. 每个因子组的时序派生特征（以 `__mean` 为主）

对每个因子组 `X__mean` 生成：

- 动量：`X__mean_mom_{1,3,12}`（环比/季度/同比的 pct_change）
- 滚动统计：`X__mean_roll_mean_{3,6,12}`、`X__mean_roll_std_{3,6,12}`

### C. 月内形态特征（同一因子月度聚合结果内部的组合）

对每个因子组（若列存在）生成：

- `X__range_over_mean`（相对波动）
- `X__last_minus_mean`（月末偏离月均）
- `X__max_minus_min`（与 `range` 同义，便于统一后续处理）

### D. 跨因子派生（更贴近业务含义）

- 成本价差/比值（现货 vs 各成本路线）：
  - `价差__PP价格_minus_<成本>__mean`
  - `比值__PP价格_div_<成本>__mean`
- 供需比值：
  - `供需__进口_div_产量__mean`
  - `供需__库存_div_产量__mean`
  - `供需__检修损失_div_产量__mean`
- 下游开工指数：
  - `指数__下游开工均值__mean`（塑编/注塑/BOPP 开工率均值）
- 若纳入期货，则额外生成基差：
  - `价差__现货_minus_期货__mean`

### 如何启用特征工程

数据集构建脚本已支持开关：

```bash
conda run -n lchen python scripts/build_pp_dataset.py --engineer-features --output outputs/datasets/pp_base_engineered.csv
conda run -n lchen python scripts/build_pp_dataset.py --include-futures --engineer-features --output outputs/datasets/pp_with_futures_engineered.csv
```

---

## 2) 描述性统计分析与可视化（原始数据 + 整理后数据）

实现脚本：`scripts/run_pp_eda.py`

### A. 原始数据（PP数据/*.xlsx）

输出（`outputs/eda/raw/`）：

- `raw_profile.csv` / `raw_profile.md`：每张表的起止时间、频率粗判、缺失率、分位数等概览
- `figures/raw_<因子>.pdf`：每张表的原始时序 + 月度平滑曲线 + 分布直方图

### B. 月度特征汇总表（未 shift，用于看覆盖/对齐）

输出（`outputs/eda/monthly/`）：

- `monthly_feature_table.csv`：把每张表聚合到月频后的 `mean/min/max/last/range` 汇总
- `monthly_coverage_heatmap.pdf`：每个因子月度可用性（1/0）
- `monthly_coverage_counts.pdf`：每个因子可用月份数量
- `lag_corr_spearman.csv` / `lag_corr_heatmap.pdf`：因子均值与 PP 价格的滞后相关（factor(t-lag) vs price(t)）

### C. 建模数据集（已 shift(1)，严格时间序列）

对每个 `--dataset` 生成一套结果（`outputs/eda/<dataset_stem>/`）：

- `target_series.pdf`：`y` 与 `y_return` 时序图 + 测试窗口阴影
- `seasonality_boxplots.pdf`：按月份的季节性箱线图（y 与 y_return）
- `missingness_heatmap.pdf`：按“因子组”统计的逐月缺失率热力图
- `top_corr_with_y.pdf` + `corr_with_y.csv`：与 y 的相关性（特征已是滞后特征）
- `acf_y.pdf` / `acf_y_return.pdf`：自相关（ACF）
- `adf_tests.csv`：ADF 平稳性检验（y 与 y_return）
- `seasonal_decompose_y.pdf`：季节分解（数据足够长时生成）

### 一键运行

```bash
# 默认会尝试分析 outputs/datasets/pp_base.csv 与 outputs/datasets/pp_with_futures.csv（若存在）
conda run -n lchen python scripts/run_pp_eda.py

# 指定数据集（可重复 --dataset）
conda run -n lchen python scripts/run_pp_eda.py --dataset outputs/datasets/pp_base.csv

# 在 EDA 前对数据集额外应用一次特征工程（用于对比）
conda run -n lchen python scripts/run_pp_eda.py --dataset outputs/datasets/pp_base.csv --engineer-features
```

---

## 3) 报告写作建议（把 EDA 放进 PDF）

建议在 PDF 中用 1–2 页呈现以下要点（图可直接引用 `outputs/eda/`）：

- 原始数据覆盖（起止时间、频率、缺失）+ “为什么要统一降频到月度”
- 目标变量 y 的趋势/波动/季节性（含测试窗口说明）
- 特征缺失结构（哪些因子在哪些年份缺失，如何处理：median+missing indicator）
- 相关性与滞后关系（强调“特征用 t-1 预测 t”，避免泄露）
