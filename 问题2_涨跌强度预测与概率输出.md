# 问题2：涨跌强度预测（分档）与概率输出

对应 `2025年个人PJ.docx` 第 2 问：在预测涨跌方向之外，进一步预测“涨跌的强度”（可自行定义强弱阈值），并输出 **具体涨跌幅度的数值预测**，例如输出“出现相关涨跌幅度区间的概率”。

> 本项目将“涨跌幅度”定义为 **月度收益率**（return），并同时提供：
>
> 1) **数值预测**：预测下月涨跌幅 `return_pred`
> 2) **概率预测**：预测强度分档的 `predict_proba`（`proba__*`）

---

## 1. 强度标签定义（可配置）

定义月度收益率：

- `r_t = (y_t - y_{t-1}) / y_{t-1}`

强度标签（五分类）默认阈值：

- `strong_threshold = 0.05`（|r|≥5% 视为大涨/大跌）
- `flat_threshold = 0.005`（|r|≤0.5% 视为不涨不跌）

分档规则：

- `r_t <= -strong_threshold` → `big_down`
- `-strong_threshold < r_t < -flat_threshold` → `small_down`
- `|r_t| <= flat_threshold` → `flat`
- `flat_threshold < r_t < strong_threshold` → `small_up`
- `r_t >= strong_threshold` → `big_up`

实现位置：`pp_forecast/q1_dataset.py:47`

> 你可以通过 `scripts/build_q1_dataset.py` 的 `--strong-threshold/--flat-threshold` 调整阈值（写报告时建议说明阈值依据，并做敏感性对比）。

---

## 2. 数据集与标签构造（与问题1一致）

构建数据集时会自动生成：

- `y`：月度目标价格（默认月均价）
- `y_prev`：上月价格
- `y_return`：真实月度涨跌幅
- `y_strength`：真实强度标签（五分类）

并严格做时间对齐：用月 t-1 的特征预测月 t（对特征做 `shift(1)`）。

---

## 3. 两种实现路径（对应题目“数值 + 概率”输出）

### 路径 A：先预测价格/涨跌幅，再映射到强度档（数值为主）

1) 用回归模型得到价格预测 `y_pred`
2) 计算数值涨跌幅预测：

- `return_pred = (y_pred - y_prev) / y_prev`

3) 将 `return_pred` 映射为强度标签 `strength_pred`

优点：

- 自然得到“涨跌幅度的数值预测”（return_pred）
- 同一套模型可同时给出价格/方向/强度

不足：

- 强度输出是“硬分档”，不会给出每一档的概率

对应输出文件：

- `outputs/metrics/<dataset_stem>/q1_test_predictions.csv`（含 `return_pred` 与 `strength_pred`）

### 路径 B：直接训练强度多分类模型输出概率（概率为主）

1) 目标变量改为 `y_strength`（五分类）
2) 训练能输出 `predict_proba` 的分类模型，输出每档概率

对应输出文件：

- `outputs/metrics/<dataset_stem>/q1_strength_test_predictions.csv`
  - `strength_true`：真实标签
  - `strength_pred`：预测标签
  - `proba__big_up / proba__small_up / proba__flat / proba__small_down / proba__big_down`：各档概率

---

## 4. 模型与参数呈现

### 4.1 强度多分类模型（predict_proba）

实现位置：`pp_forecast/q1_models.py:150`

当前提供多种可对比模型：

- `logreg`：多项 Logistic 回归
- `rf_clf` / `extra_trees_clf`：随机森林/极端随机树
- `gbr_clf` / `ada_clf`：提升树/Boosting
- `svc_rbf`：SVC（开启 `probability=True`）
- `nb`：Gaussian Naive Bayes
- `knn_clf`：KNN（样本很少时可能失败，已记录到 failures）

参数会写到：`outputs/metrics/<dataset_stem>/q1_strength_params_<model>.json`。

### 4.2 预处理

与问题1一致：

- `median` 填补 + missing indicator
- 标准化（StandardScaler）

---

## 5. 评估方法（时间序列）

测试划分使用连续时间窗（默认 `2021-01` ~ `2021-07`），指标包括：

- `Strength_Accuracy`
- `Strength_Precision_macro / Strength_Recall_macro / Strength_F1_macro`

> 说明：强度标签本质是有序类别（从 big_down → big_up），macro-F1 把它当作无序多分类。写报告时可作为“现阶段实现”，并在“不足与展望”里提出更适合的序数分类/回归方案（见第 7 节）。

---

## 6. 结果对比（一次运行示例）

以下为默认测试窗（2021-01~2021-07）的一次结果摘要；完整对比见 `outputs/metrics/<dataset_stem>/q1_strength_model_metrics.csv`。

|数据集|说明|最佳模型（按 F1_macro）|F1_macro|Accuracy|Precision_macro|Recall_macro|
|---|---|---:|---:|---:|---:|---:|
|`q1_long`|不含期货|`rf_clf`|0.444|0.571|0.367|0.583|
|`q1_long_engineered`|不含期货 + 特征工程|`ada_clf`|0.489|0.714|0.556|0.500|
|`q1_with_futures`|含期货（restrict）|`logreg`|0.242|0.571|0.190|0.333|
|`q1_with_futures_engineered`|含期货 + 特征工程（restrict）|`ada_clf`|0.413|0.571|0.389|0.500|

总体观察（就本次测试窗而言）：

- long sample + 额外特征工程对“强度分档”也有帮助；
- `restrict` 会显著缩短期货样本长度，建议写报告时注明并与“不含期货”结果并列呈现。

---

## 7. 可扩展方向（写报告“不足与展望”很合适）

如果希望更贴近“输出具体涨跌幅度分布/概率”的表述，可以考虑：

- **阈值敏感性**：对 `5%/0.5%` 做网格对比，报告稳健性
- **概率校准**：对分类概率做 calibration（Platt/Isotonic），提高可解释性
- **分布预测/区间预测**：
  - 分位数回归（Quantile Regression）给出上涨/下跌幅度区间
  - 直接对 `y_return` 做回归，再把连续预测映射成概率（例如假设残差分布）
- **序数分类**：把 5 档作为有序标签，用更合适的损失与评估（MAE on class index 等）

---

## 8. 可复现运行方式

```bash
# 1) 构建数据集（同时会生成 y_return / y_strength）
conda run -n lchen python scripts/build_q1_dataset.py --target-metric mean --output outputs/datasets/q1_long.csv

# 可选：开启额外特征工程
conda run -n lchen python scripts/build_q1_dataset.py --engineer-features --output outputs/datasets/q1_long_engineered.csv

# 2) 训练与评估（会同时输出“回归派生强度”与“强度多分类概率”）
conda run -n lchen python scripts/run_q1_models.py --dataset outputs/datasets/q1_long.csv
conda run -n lchen python scripts/run_q1_models.py --dataset outputs/datasets/q1_long_engineered.csv
```

