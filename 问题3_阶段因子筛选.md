# 问题3：分阶段关键因子自动筛选与权重（实现说明）

对应 `2025年个人PJ.docx` 第3问：考虑行业周期，不同阶段的关键预测因子可能不同；需要自动筛选每个阶段最适用于价格预测的关键因子组合，并计算其在模型中的影响权重。

## 1. 阶段（Stage）如何自动划分

当前实现采用“趋势 + 波动”两维特征定义市场状态（regime），并将相同 regime 的连续月份合并为一个阶段：

- **趋势**：过去 `trend_window` 个月的累计涨跌幅（默认 6 个月）  
  `trend_t = y_t / y_{t-trend_window} - 1`
- **波动**：过去 `vol_window` 个月的月度涨跌幅标准差（默认 6 个月）  
  `vol_t = std(r_{t-vol_window+1...t})`
- **regime 标签**：
  - `trend >= trend_threshold` → `up`
  - `trend <= -trend_threshold` → `down`
  - 否则 → `flat`
  - `vol` 高于历史分位点 `vol_quantile` → `high_vol`，否则 `low_vol`
  - 最终 regime 形如：`up_high_vol` / `down_low_vol` / `flat_high_vol` ...
- **短阶段合并**：若某个连续段长度 `< min_stage_len`（默认 6 个月），会合并到相邻阶段（优先合并到“月度收益均值更接近”的邻段），以避免过碎。

实现代码：`pp_forecast/q3_stage.py`

## 2. 每个阶段的关键因子如何自动筛选

### 2.1 因子分组口径（关键）

建模数据集中，列名形如 `因子名__mean/min/max/last/range`。  
本实现按 `__` 前缀对特征自动分组，例如：

- `PP产量__mean`、`PP产量__range` → 归为因子组 `PP产量`
- `丙烯成本__min`、`丙烯成本__last` → 归为因子组 `丙烯成本`

（默认）为了突出产业链因子差异，筛选时会 **排除**：

- `PP价格`（自回归特征，几乎总是最强）
- `Calendar`（`cal_year/cal_month`）

可用脚本参数打开：`--include-own-price`、`--include-calendar`

### 2.2 权重与筛选规则（Ridge）

对每个阶段内的数据，拟合一个线性回归模型（Ridge）：

- 缺失值：训练内按 `median` 填补，并加入缺失指示（与问题1/2一致）
- 标准化：`StandardScaler()`（使系数可比较）
- 因子组权重：对同一因子组下所有特征的 `|coef|` 求和，再做归一化  
  `weight(group) = sum_{f in group} |coef_f| / sum_all |coef|`
- Top-K 因子组：按 `weight(group)` 取前 `top_k`（默认 6）

输出的 `q3_ridge_group_weights.csv` 中，`group_abs_weight` 即该阶段“因子影响权重”（绝对系数归一化权重）。

## 3. 可运行脚本与输出

运行：

```bash
python scripts/run_q3_stage_factor_selection.py --dataset outputs/datasets/q1_long.csv
python scripts/run_q3_stage_factor_selection.py --dataset outputs/datasets/q1_with_futures.csv --also-strength
```

输出目录：`outputs/q3/<dataset_stem>/`

- `q3_stage_summary.csv`：阶段起止、累计涨跌、波动汇总
- `q3_stage_assignments.csv`：逐月阶段标签（stage_id + regime）
- `q3_ridge_group_weights.csv`：各阶段因子组权重（Top-K 标记在 `is_topk`）
- `q3_ridge_top_features.csv`：各阶段 Top 因子组内的代表性特征（Top-N）
- `q3_stages_price.png`：价格曲线与阶段分割线（若 Matplotlib 可用）
- `q3_failures.json`：被跳过的阶段/拟合失败原因（若有）

## 4. 后续可扩展点（写报告时可当“不足与展望”）

- 阶段划分可替换为：变点检测（change point）、HMM、或聚类 + 连续性约束（更贴近“行业周期”）
- 因子筛选可替换为：Permutation Importance、稳定性选择（stability selection）、或“按组”的稀疏化方法（Group Lasso）
- 权重可对比不同模型（如 RF/GBR 的 permutation importance）提升稳健性

